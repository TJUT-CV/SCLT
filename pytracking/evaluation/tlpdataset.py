import numpy as np
from pytracking.evaluation.data import Sequence, BaseDataset, SequenceList
from pytracking.utils.load_text import load_text


class TLPDataset(BaseDataset):
    """ OTB-2015 dataset

    Publication:
        Object Tracking Benchmark
        Wu, Yi, Jongwoo Lim, and Ming-hsuan Yan
        TPAMI, 2015
        http://faculty.ucmerced.edu/mhyang/papers/pami15_tracking_benchmark.pdf

    Download the dataset from http://cvlab.hanyang.ac.kr/tracker_benchmark/index.html
    """
    def __init__(self):
        super().__init__()
        # self.base_path = r'/home/ubuntu/zzb/data/OTB100'
        self.base_path = self.env_settings.tlp_path
        self.sequence_info_list = self._get_sequence_info_list()

    def get_sequence_list(self):
        return SequenceList([self._construct_sequence(s) for s in self.sequence_info_list])

    def _construct_sequence(self, sequence_info):
        sequence_path = sequence_info['path']
        nz = sequence_info['nz']
        ext = sequence_info['ext']
        start_frame = sequence_info['startFrame']
        end_frame = sequence_info['endFrame']

        init_omit = 0
        if 'initOmit' in sequence_info:
            init_omit = sequence_info['initOmit']
        frames = ['{base_path}/{sequence_path}/{frame:0{nz}}.{ext}'.format(base_path=self.base_path, 
        sequence_path=sequence_path, frame=frame_num, nz=nz, ext=ext) for frame_num in range(start_frame+init_omit, end_frame+1)]


        anno_path = '{}/{}'.format(self.base_path, sequence_info['anno_path'])

        # NOTE: OTB has some weird annos which panda cannot handle
        ground_truth_rect = load_text(str(anno_path), delimiter=(',', None), dtype=np.float64, backend='numpy')
        temp_row=[1,2,3,4]
        return Sequence(sequence_info['name'], frames, 'tlp', ground_truth_rect[init_omit:,temp_row],
                        object_class=sequence_info['object_class'])

    def __len__(self):
        return len(self.sequence_info_list)

    def _get_sequence_info_list(self):
        sequence_info_list = [{'name': 'Alladin', 'path': 'Alladin/img', 'startFrame': 1, 'endFrame': 8992, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Alladin/groundtruth_rect.txt', 'object_class': 'Alladin'}, {'name': 'Aquarium1', 'path': 'Aquarium1/img', 'startFrame': 1, 'endFrame': 7337, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Aquarium1/groundtruth_rect.txt', 'object_class': 'Aquarium1'}, {'name': 'Aquarium2', 'path': 'Aquarium2/img', 'startFrame': 1, 'endFrame': 8182, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Aquarium2/groundtruth_rect.txt', 'object_class': 'Aquarium2'}, {'name': 'Badminton1', 'path': 'Badminton1/img', 'startFrame': 1, 'endFrame': 15240, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Badminton1/groundtruth_rect.txt', 'object_class': 'Badminton1'}, {'name': 'Badminton2', 'path': 'Badminton2/img', 'startFrame': 1, 'endFrame': 16920, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Badminton2/groundtruth_rect.txt', 'object_class': 'Badminton2'}, {'name': 'Basketball', 'path': 'Basketball/img', 'startFrame': 1, 'endFrame': 17970, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Basketball/groundtruth_rect.txt', 'object_class': 'Basketball'}, {'name': 'Bharatanatyam', 'path': 'Bharatanatyam/img', 'startFrame': 1, 'endFrame': 15936, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Bharatanatyam/groundtruth_rect.txt', 'object_class': 'Bharatanatyam'}, {'name': 'Bike', 'path': 'Bike/img', 'startFrame': 1, 'endFrame': 4196, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Bike/groundtruth_rect.txt', 'object_class': 'Bike'}, {'name': 'Billiards1', 'path': 'Billiards1/img', 'startFrame': 1, 'endFrame': 20375, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Billiards1/groundtruth_rect.txt', 'object_class': 'Billiards1'}, {'name': 'Billiards2', 'path': 'Billiards2/img', 'startFrame': 1, 'endFrame': 20070, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Billiards2/groundtruth_rect.txt', 'object_class': 'Billiards2'}, {'name': 'Boat', 'path': 'Boat/img', 'startFrame': 1, 'endFrame': 6234, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Boat/groundtruth_rect.txt', 'object_class': 'Boat'}, {'name': 'Boxing1', 'path': 'Boxing1/img', 'startFrame': 1, 'endFrame': 20670, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Boxing1/groundtruth_rect.txt', 'object_class': 'Boxing1'}, {'name': 'Boxing2', 'path': 'Boxing2/img', 'startFrame': 1, 'endFrame': 21180, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Boxing2/groundtruth_rect.txt', 'object_class': 'Boxing2'}, {'name': 'Boxing3', 'path': 'Boxing3/img', 'startFrame': 1, 'endFrame': 19590, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Boxing3/groundtruth_rect.txt', 'object_class': 'Boxing3'}, {'name': 'BreakfastClub', 'path': 'BreakfastClub/img', 'startFrame': 1, 'endFrame': 22600, 'nz': 5, 'ext': 'jpg', 'anno_path': 'BreakfastClub/groundtruth_rect.txt', 'object_class': 'BreakfastClub'}, {'name': 'CarChase1', 'path': 'CarChase1/img', 'startFrame': 1, 'endFrame': 8932, 'nz': 5, 'ext': 'jpg', 'anno_path': 'CarChase1/groundtruth_rect.txt', 'object_class': 'CarChase1'}, {'name': 'CarChase2', 'path': 'CarChase2/img', 'startFrame': 1, 'endFrame': 14010, 'nz': 5, 'ext': 'jpg', 'anno_path': 'CarChase2/groundtruth_rect.txt', 'object_class': 'CarChase2'}, {'name': 'CarChase3', 'path': 'CarChase3/img', 'startFrame': 1, 'endFrame': 22860, 'nz': 5, 'ext': 'jpg', 'anno_path': 'CarChase3/groundtruth_rect.txt', 'object_class': 'CarChase3'}, {'name': 'Dashcam', 'path': 'Dashcam/img', 'startFrame': 1, 'endFrame': 10260, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Dashcam/groundtruth_rect.txt', 'object_class': 'Dashcam'}, {'name': 'DriftCar1', 'path': 'DriftCar1/img', 'startFrame': 1, 'endFrame': 10130, 'nz': 5, 'ext': 'jpg', 'anno_path': 'DriftCar1/groundtruth_rect.txt', 'object_class': 'DriftCar1'}, {'name': 'DriftCar2', 'path': 'DriftCar2/img', 'startFrame': 1, 'endFrame': 8572, 'nz': 5, 'ext': 'jpg', 'anno_path': 'DriftCar2/groundtruth_rect.txt', 'object_class': 'DriftCar2'}, {'name': 'Drone1', 'path': 'Drone1/img', 'startFrame': 1, 'endFrame': 4320, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Drone1/groundtruth_rect.txt', 'object_class': 'Drone1'}, {'name': 'Drone2', 'path': 'Drone2/img', 'startFrame': 1, 'endFrame': 8812, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Drone2/groundtruth_rect.txt', 'object_class': 'Drone2'}, {'name': 'Drone3', 'path': 'Drone3/img', 'startFrame': 1, 'endFrame': 6594, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Drone3/groundtruth_rect.txt', 'object_class': 'Drone3'}, {'name': 'Elephants', 'path': 'Elephants/img', 'startFrame': 1, 'endFrame': 4376, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Elephants/groundtruth_rect.txt', 'object_class': 'Elephants'}, {'name': 'Helicopter', 'path': 'Helicopter/img', 'startFrame': 1, 'endFrame': 17053, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Helicopter/groundtruth_rect.txt', 'object_class': 'Helicopter'}, {'name': 'Hideaway', 'path': 'Hideaway/img', 'startFrame': 1, 'endFrame': 5900, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Hideaway/groundtruth_rect.txt', 'object_class': 'Hideaway'}, {'name': 'ISS', 'path': 'ISS/img', 'startFrame': 1, 'endFrame': 28562, 'nz': 5, 'ext': 'jpg', 'anno_path': 'ISS/groundtruth_rect.txt', 'object_class': 'ISS'}, {'name': 'IceSkating', 'path': 'IceSkating/img', 'startFrame': 1, 'endFrame': 8125, 'nz': 5, 'ext': 'jpg', 'anno_path': 'IceSkating/groundtruth_rect.txt', 'object_class': 'IceSkating'}, {'name': 'Jet1', 'path': 'Jet1/img', 'startFrame': 1, 'endFrame': 7403, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Jet1/groundtruth_rect.txt', 'object_class': 'Jet1'}, {'name': 'Jet2', 'path': 'Jet2/img', 'startFrame': 1, 'endFrame': 18882, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Jet2/groundtruth_rect.txt', 'object_class': 'Jet2'}, {'name': 'Jet3', 'path': 'Jet3/img', 'startFrame': 1, 'endFrame': 17953, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Jet3/groundtruth_rect.txt', 'object_class': 'Jet3'}, {'name': 'Jet4', 'path': 'Jet4/img', 'startFrame': 1, 'endFrame': 10160, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Jet4/groundtruth_rect.txt', 'object_class': 'Jet4'}, {'name': 'Jet5', 'path': 'Jet5/img', 'startFrame': 1, 'endFrame': 13675, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Jet5/groundtruth_rect.txt', 'object_class': 'Jet5'}, {'name': 'KinBall1', 'path': 'KinBall1/img', 'startFrame': 1, 'endFrame': 20230, 'nz': 5, 'ext': 'jpg', 'anno_path': 'KinBall1/groundtruth_rect.txt', 'object_class': 'KinBall1'}, {'name': 'KinBall2', 'path': 'KinBall2/img', 'startFrame': 1, 'endFrame': 13575, 'nz': 5, 'ext': 'jpg', 'anno_path': 'KinBall2/groundtruth_rect.txt', 'object_class': 'KinBall2'}, {'name': 'KinBall3', 'path': 'KinBall3/img', 'startFrame': 1, 'endFrame': 14940, 'nz': 5, 'ext': 'jpg', 'anno_path': 'KinBall3/groundtruth_rect.txt', 'object_class': 'KinBall3'}, {'name': 'Lion', 'path': 'Lion/img', 'startFrame': 1, 'endFrame': 6570, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Lion/groundtruth_rect.txt', 'object_class': 'Lion'}, {'name': 'Mohiniyattam', 'path': 'Mohiniyattam/img', 'startFrame': 1, 'endFrame': 15456, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Mohiniyattam/groundtruth_rect.txt', 'object_class': 'Mohiniyattam'}, {'name': 'MotorcycleChase', 'path': 'MotorcycleChase/img', 'startFrame': 1, 'endFrame': 5550, 'nz': 5, 'ext': 'jpg', 'anno_path': 'MotorcycleChase/groundtruth_rect.txt', 'object_class': 'MotorcycleChase'}, {'name': 'Parakeet', 'path': 'Parakeet/img', 'startFrame': 1, 'endFrame': 21609, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Parakeet/groundtruth_rect.txt', 'object_class': 'Parakeet'}, {'name': 'PolarBear1', 'path': 'PolarBear1/img', 'startFrame': 1, 'endFrame': 9501, 'nz': 5, 'ext': 'jpg', 'anno_path': 'PolarBear1/groundtruth_rect.txt', 'object_class': 'PolarBear1'}, {'name': 'PolarBear2', 'path': 'PolarBear2/img', 'startFrame': 1, 'endFrame': 27153, 'nz': 5, 'ext': 'jpg', 'anno_path': 'PolarBear2/groundtruth_rect.txt', 'object_class': 'PolarBear2'}, {'name': 'PolarBear3', 'path': 'PolarBear3/img', 'startFrame': 1, 'endFrame': 9531, 'nz': 5, 'ext': 'jpg', 'anno_path': 'PolarBear3/groundtruth_rect.txt', 'object_class': 'PolarBear3'}, {'name': 'Puppies1', 'path': 'Puppies1/img', 'startFrame': 1, 'endFrame': 17730, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Puppies1/groundtruth_rect.txt', 'object_class': 'Puppies1'}, {'name': 'Puppies2', 'path': 'Puppies2/img', 'startFrame': 1, 'endFrame': 22620, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Puppies2/groundtruth_rect.txt', 'object_class': 'Puppies2'}, {'name': 'Rope', 'path': 'Rope/img', 'startFrame': 1, 'endFrame': 17503, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Rope/groundtruth_rect.txt', 'object_class': 'Rope'}, {'name': 'Sam', 'path': 'Sam/img', 'startFrame': 1, 'endFrame': 4628, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Sam/groundtruth_rect.txt', 'object_class': 'Sam'}, {'name': 'Violinist', 'path': 'Violinist/img', 'startFrame': 1, 'endFrame': 6844, 'nz': 5, 'ext': 'jpg', 'anno_path': 'Violinist/groundtruth_rect.txt', 'object_class': 'Violinist'}, {'name': 'ZebraFish', 'path': 'ZebraFish/img', 'startFrame': 1, 'endFrame': 10920, 'nz': 5, 'ext': 'jpg', 'anno_path': 'ZebraFish/groundtruth_rect.txt', 'object_class': 'ZebraFish'}]
        return sequence_info_list
